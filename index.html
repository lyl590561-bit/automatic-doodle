<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نسمة نت - النسخة المطورة</title>
<style>
body{margin:0;font-family:Tahoma,sans-serif;background:#071a2d;color:#fff;text-align:center}
.container{max-width:700px;margin:20px auto;background:#000;padding:20px;border-radius:16px;box-shadow: 0 4px 15px rgba(0,0,0,0.5)}
h1{font-size:50px;color:#ffd600;margin:10px 0}
h2{font-size:36px;margin-bottom:20px}
input,select{width:90%;padding:12px;margin:8px 0;font-size:18px;border-radius:10px;border:none;outline:none}
button{width:75%;padding:14px;margin:10px 0;font-size:20px;border-radius:12px;border:none;background:#5bbce8;cursor:pointer;transition:.3s;font-weight:bold}
button:hover{background:#39a0d0;transform: scale(1.02)}
.status{color:#ff4444;font-size:18px;margin-top:10px}
.user-box{background:#1e3a5f;border-radius:14px;padding:16px;margin-bottom:12px;font-size:20px;font-weight:bold;border: 1px solid #333}
.user-box.alert{background:#9e2b2b;border: 1px solid #ff0000}
.user-box span{display:block;margin-top:8px;font-size:22px;color:#ffd600}
.user-card{background:#222;padding:14px;border-radius:12px;margin:10px 0;border-left: 5px solid #5bbce8}
.user-card input{width:80%;padding:6px;margin-top:5px;font-size: 14px}
.user-card button{padding:8px 12px;margin-top:10px;width:auto;font-size:14px;background:#ffd600;color:#000}
</style>
</head>
<body>

<div class="container" id="login">
    <h1>نسمة نت</h1>
    <h2>NESMAH NET</h2>
    <div id="marquee-container" style="background:#8aff00;padding:10px;margin-bottom:20px;border-radius:8px;color:#000;font-weight:bold">
        <marquee id="marquee-text">للتواصل معنا 0925971747</marquee>
    </div>
    <input id="user" placeholder="اسم المستخدم">
    <input id="pass" type="password" placeholder="كلمة المرور">
    <button onclick="login()">دخول</button>
    <div class="status" id="msg"></div>
</div>

<div class="container" id="panel" style="display:none"></div>

<div class="container" id="add-user-page" style="display:none">
    <h2>إضافة مستخدم جديد</h2>
    <input id="new-username" placeholder="اسم المستخدم الجديد">
    <input id="new-pass" placeholder="كلمة المرور">
    <hr>
    <label>تحديد الوقت:</label><br>
    <input id="new-time" type="number" placeholder="الوقت" value="60" style="width:40%">
    <select id="new-time-unit" style="width:45%">
      <option value="seconds">ثانية</option>
      <option value="minutes" selected>دقيقة</option>
      <option value="hours">ساعة</option>
      <option value="days">يوم</option>
    </select>
    <br>
    <label>تحديد البيانات:</label><br>
    <input id="new-kb" type="number" placeholder="الحجم" value="1024" style="width:40%">
    <select id="new-kb-unit" style="width:45%">
      <option value="KB">KiB</option>
      <option value="MB" selected>MiB</option>
      <option value="GB">GB</option>
    </select>
    <button onclick="confirmAddUser()" style="background:#8aff00;color:#000">تأكيد الإضافة</button>
    <button onclick="backToAdmin()" style="background:#555">إلغاء</button>
</div>

<script>
// ===== البيانات الأساسية =====
const DB_KEY = "nesmah_users";
const DEFAULT_USERS = {
    admin: {pass:"12345", kb:999999999, time:999999999, upload:0, used:0, online:true, speed:0}
};

if(!localStorage.getItem(DB_KEY)) localStorage.setItem(DB_KEY, JSON.stringify(DEFAULT_USERS));
let users = JSON.parse(localStorage.getItem(DB_KEY));
let current = null;

// ===== محرك العمليات =====
function save() { localStorage.setItem(DB_KEY, JSON.stringify(users)); }

function login() {
    let u = document.getElementById("user").value.trim();
    let p = document.getElementById("pass").value.trim();
    if(!users[u] || users[u].pass !== p) {
        document.getElementById("msg").innerText = "خطأ في اسم المستخدم أو كلمة المرور";
        return;
    }
    if(u !== "admin" && (users[u].time <= 0 || users[u].kb <= 0)) {
        document.getElementById("msg").innerText = "عذراً، هذا الكرت منتهي الصلاحية";
        return;
    }
    current = u;
    users[current].online = true;
    save();
    document.getElementById("login").style.display = "none";
    document.getElementById("panel").style.display = "block";
    render();
}

function formatTime(sec) {
    let d = Math.floor(sec/86400), h = Math.floor((sec%86400)/3600), m = Math.floor((sec%3600)/60), s = sec%60;
    return `${d}ي ${h}سا ${m}د ${s}ث`;
}

function render() {
    let panel = document.getElementById("panel");
    if(current === "admin") {
        let html = `<h2>لوحة الإدارة</h2>
        <button onclick="showAddUserPage()">+ إضافة مستخدم</button>
        <button onclick="showOnlineUsers()">المتصلون الآن</button>
        <button onclick="editMarquee()">تعديل الإعلان</button>
        <div style="margin:15px 0">إجمالي المشتركين: ${Object.keys(users).length - 1}</div>`;
        
        for(let k in users) {
            if(k === "admin") continue;
            html += `<div class="user-card">
                <b>المستخدم: ${k}</b> | <span style="color:${users[k].online?'#8aff00':'#ff4444'}">${users[k].online?'متصل':'أوفلاين'}</span><br>
                كلمة السر: <input type="text" value="${users[k].pass}" onchange="users['${k}'].pass=this.value;save()"><br>
                الوقت المتبقي (ث): <input type="number" value="${users[k].time}" onchange="users['${k}'].time=parseInt(this.value);save()"><br>
                رصيد البيانات (KB): <input type="number" value="${users[k].kb}" onchange="users['${k}'].kb=parseInt(this.value);save()"><br>
                <button onclick="delUser('${k}')" style="background:#ff4444;color:#fff">حذف الكرت</button>
            </div>`;
        }
        panel.innerHTML = html + `<button onclick="logout()" style="background:#555">تسجيل خروج</button>`;
    } else {
        let u = users[current];
        panel.innerHTML = `
            <div class="user-box alert">تنبيه<br>اتقِ الله في استخدامك للإنترنت</div>
            <div class="user-box">مرحباً بك<span>${current}</span></div>
            <div class="user-box">الوقت المتبقي<span id="live-time">${formatTime(u.time)}</span></div>
            <div class="user-box">البيانات المتبقية<span id="live-kb">${(u.kb/1024).toFixed(2)} MiB</span></div>
            <div class="user-box">استهلاك الجلسة الحالية<span id="live-used">${u.used} ثانية</span></div>
            <button onclick="logout()">قطع الاتصال</button>
        `;
    }
}

// ===== إدارة المستخدمين =====
function showAddUserPage() { 
    document.getElementById("panel").style.display="none"; 
    document.getElementById("add-user-page").style.display="block"; 
}

function backToAdmin() { 
    document.getElementById("add-user-page").style.display="none"; 
    document.getElementById("panel").style.display="block"; 
    render(); 
}

function confirmAddUser() {
    let u = document.getElementById("new-username").value.trim();
    let p = document.getElementById("new-pass").value.trim();
    if(!u || !p) { alert("أكمل البيانات أولاً"); return; }
    if(users[u]) { alert("اسم المستخدم موجود بالفعل!"); return; }

    let t = parseInt(document.getElementById("new-time").value);
    let tUnit = document.getElementById("new-time-unit").value;
    let kb = parseFloat(document.getElementById("new-kb").value);
    let kbUnit = document.getElementById("new-kb-unit").value;

    if(tUnit==="minutes") t*=60; else if(tUnit==="hours") t*=3600; else if(tUnit==="days") t*=86400;
    if(kbUnit==="MB") kb*=1024; else if(kbUnit==="GB") kb*=1024*1024;

    users[u] = {pass:p, time:t, kb:kb, kb_original:kb, upload:0, used:0, online:false, speed:0};
    save();
    backToAdmin();
}

function delUser(u) { if(confirm(`حذف ${u} نهائياً؟`)) { delete users[u]; save(); render(); } }

function editMarquee() {
    let text = prompt("أدخل نص الشريط المتحرك الجديد:", document.getElementById("marquee-text").innerText);
    if(text) document.getElementById("marquee-text").innerText = text;
}

function showOnlineUsers() {
    let count = 0;
    let list = "";
    for(let k in users) if(k!=="admin" && users[k].online) { count++; list += `<li>${k}</li>`; }
    alert(`المتصلون الآن (${count}):\n${list || "لا يوجد أحد متصل"}`);
}

function logout() {
    if(current) users[current].online = false;
    save();
    location.reload();
}

// ===== العداد الحي =====
setInterval(() => {
    if(!current || current === "admin") return;
    
    users[current].time--;
    users[current].used++;
    // خصم بيانات وهمي بسيط (10KB لكل ثانية كمثال) أو يمكنك تعديله
    users[current].kb -= 10; 

    if(users[current].time <= 0 || users[current].kb <= 0) {
        alert("انتهى رصيدك!");
        logout();
    }
    
    // تحديث الأرقام في الشاشة دون إعادة بناء الصفحة (أداء أفضل)
    let timeEl = document.getElementById("live-time");
    let kbEl = document.getElementById("live-kb");
    let usedEl = document.getElementById("live-used");
    
    if(timeEl) timeEl.innerText = formatTime(users[current].time);
    if(kbEl) kbEl.innerText = (users[current].kb / 1024).toFixed(2) + " MiB";
    if(usedEl) usedEl.innerText = users[current].used + " ثانية";
    
    save();
}, 1000);
</script>
</body>
                                                            </html>
        
